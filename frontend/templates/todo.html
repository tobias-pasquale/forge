{% extends "base.html" %}

{% block content %}
  <h1 class="mb-4">Your Forge Tasks</h1>

  <!-- Flash Messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <!-- Motivational Streak Message -->
  {% if streak %}
    <div class="alert alert-warning">
      ðŸ”¥ <strong>{{ message }}</strong>
    </div>
  {% endif %}

  <!-- Task Entry Form -->
  <form method="POST" class="mb-4 row g-2 align-items-end">
    {{ form.hidden_tag() }}
  
    <div class="col-md-5">
      {{ form.task.label(class="form-label") }}
      {{ form.task(class="form-control", placeholder="Add a new task...") }}
    </div>
  
    <div class="col-md-2">
      {{ form.due_date.label(class="form-label") }}
      {{ form.due_date(class="form-control") }}
    </div>
  
    <div class="col-md-2">
      {{ form.priority.label(class="form-label") }}
      {{ form.priority(class="form-select") }}
    </div>
  
    <div class="col-md-2">
      {{ form.recurring.label(class="form-label") }}
      {{ form.recurring(class="form-select") }}
    </div>
  
    <div class="col-md-1">
      {{ form.submit(class="btn btn-warning w-100") }}
    </div>
  </form>
  

  {# Split active and completed tasks #}
  {% set active_tasks = tasks | selectattr("completed", "equalto", False) | list %}
  {% set completed_tasks = tasks | selectattr("completed", "equalto", True) | list %}

  <!-- Active Tasks -->
  <h5 class="mb-3 text-warning">Active Tasks</h5>
  <ul class="list-group mb-4">
    {% for task in active_tasks %}
      <li class="list-group-item d-flex justify-content-between align-items-center border-secondary">
        <form action="{{ url_for('main.complete_task', task_id=task.id) }}" method="POST" class="d-flex align-items-center">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="checkbox" name="completed" onchange="this.form.submit()" class="form-check-input me-2" {% if task.completed %}checked{% endif %}>
          <span style="{% if task.completed %}text-decoration: line-through; color: #aaa;{% endif %}">
            {{ task.task }}
          </span>
        </form>
        <div class="d-flex align-items-center">
          <button class="btn btn-sm btn-outline-secondary me-1" onclick="toggleEditForm({{ task.id }})">
            <i class="bi bi-pencil"></i>
          </button>
          <button class="btn btn-sm btn-outline-danger" onclick="openDeleteModal({{ task.id }})" type="button">
            <i class="bi bi-trash"></i>
          </button>
        </div>
      </li>
    {% else %}
      <li class="list-group-item text-center text-muted border-secondary">No active tasks. Go do something dangerous and fulfilling.</li>
    {% endfor %}
  </ul>

  <!-- Collapse Button for Completed Tasks -->
  <button class="btn btn-sm btn-outline-secondary mb-3" type="button" data-bs-toggle="collapse" data-bs-target="#completedTasks" aria-expanded="false" aria-controls="completedTasks">
    Show Completed Tasks ({{ completed_tasks | length }})
  </button>

  <!-- Completed Tasks Section -->
  <div class="collapse" id="completedTasks">
    <h5 class="mt-3 mb-2 text-muted">Completed Tasks</h5>
    <ul class="list-group mb-4">
      {% for task in completed_tasks %}
        <li class="list-group-item d-flex justify-content-between align-items-center text-muted border-secondary">
          <form action="{{ url_for('main.complete_task', task_id=task.id) }}" method="POST" class="d-flex align-items-center">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="checkbox" name="completed" onchange="this.form.submit()" class="form-check-input me-2" checked>
            <span style="text-decoration: line-through; color: #666;">
              {{ task.task }}
            </span>
          </form>
          <div class="d-flex align-items-center">
            <button class="btn btn-sm btn-outline-secondary me-1" onclick="toggleEditForm({{ task.id }})">
              <i class="bi bi-pencil"></i>
            </button>
            <button class="btn btn-sm btn-outline-danger" onclick="openDeleteModal({{ task.id }})" type="button">
              <i class="bi bi-trash"></i>
            </button>
          </div>
        </li>
      {% else %}
        <li class="list-group-item text-center text-muted border-secondary">
          Nothing completed. Start somewhere.
        </li>
      {% endfor %}
    </ul>
  </div>

  <!-- Ask Forge AI -->
  <form method="POST" action="{{ url_for('main.ask_gpt') }}" class="mb-4">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <div class="mb-3">
      <label for="prompt" class="form-label text-warning">Ask Forge AI</label>
      <textarea name="prompt" rows="2" class="form-control" placeholder="Ask Forge AI"></textarea>
    </div>
    <button type="submit" class="btn btn-outline-warning">Ask Forge</button>
  </form>

  <!-- GPT Response -->
  {% if response %}
    <div class="alert alert-info mt-4 forge-memory-response">
      <strong>Forge AI:</strong><br>
      {{ response }}
    </div>
  {% endif %}

  <!-- Optional Memory Log -->
  {% if memories %}
  <div class="card border border-secondary mb-5">
    <div class="card-header text-warning">Forge AI Memory</div>
    <div class="card-body">
      {% for mem in memories %}
        <div class="mb-3">
          <div><strong class="forge-memory-user">ðŸ§  You:</strong> {{ mem.prompt }}</div>
          <div class="text-muted"><strong>ðŸ¦¾ Forge AI:</strong> {{ mem.response }}</div>
          <div class="text-end">
            <small class="text-secondary">{{ mem.created_at.strftime('%b %d, %I:%M %p') }}</small>
          </div>
        </div>
        {% if not loop.last %}<hr>{% endif %}
      {% endfor %}
    </div>
  </div>
  {% endif %}

{% endblock %}
